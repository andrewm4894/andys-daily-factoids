name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Run ESLint
      run: |
        cd frontend
        npm run lint
    
    - name: Check code formatting
      run: |
        cd frontend
        npm run lint -- --fix --dry-run
    
    - name: Validate Netlify Functions syntax
      run: |
        # Check that all Netlify functions are valid JavaScript
        for file in netlify/functions/*.js; do
          echo "Validating syntax for $file"
          node -c "$file"
        done

  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Run security audit (frontend)
      run: |
        cd frontend
        npm audit --audit-level moderate
    
    - name: Check Netlify Functions for security issues
      run: |
        # Basic security checks for Netlify functions
        echo "Checking for common security issues in Netlify functions..."
        # Check for hardcoded secrets (basic check)
        if grep -r "password\|secret\|key" netlify/functions/ --include="*.js" | grep -v "//" | grep -v "process.env"; then
          echo "Warning: Potential hardcoded secrets found in Netlify functions"
        fi

  dependency-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Check for outdated dependencies (frontend)
      run: |
        cd frontend
        npm outdated || true
    
    - name: Check Netlify Functions dependencies
      run: |
        echo "Netlify functions use serverless runtime - no package.json dependencies to check"
